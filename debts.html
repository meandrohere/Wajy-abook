<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØµÙØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        h1 { 
            text-align: center; 
            font-size: 32px; 
            margin-bottom: 30px; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            color: #ff9800;
        }
        .tracker-container {
            max-width: 1000px; /* ØªÙ… Ø§Ù„ØªÙˆØ³ÙŠØ¹ Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        .debt-table {
            width: 100%;
            border-collapse: collapse;
            text-align: right;
            font-size: 15px;
            background: #fff;
            color: #333;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }
        .debt-table th, .debt-table td {
            border: 1px solid #ddd;
            padding: 12px 15px;
        }
        .debt-table th {
            background-color: #f2f2f2;
            color: #333;
            font-weight: bold;
        }
        .debt-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .debt-table tr:hover {
            background-color: #ffe0b2;
        }
        .debt-amount {
            font-weight: bold;
            color: #f44336; /* Ù„ÙˆÙ† Ø£Ø­Ù…Ø± Ù„Ù„Ù…Ø¨Ù„Øº */
        }

        button {
            background: #2196f3; 
            color: white; 
            font-weight: bold; 
            padding: 10px 30px;
            margin-top: 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.3s;
            display: block;
            width: fit-content;
        }
        button:hover {
            filter: brightness(1.1);
        }
        
        #loading-message {
            text-align: center;
            color: #fff;
            font-size: 18px;
            padding: 50px;
        }
    </style>
</head>
<body onload="loadDebtTracker()">

    <div class="tracker-container">
        <h1>ğŸ’° ØµÙØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©</h1>
        
        <div id="debtListContainer">
            <p id="loading-message">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
        </div>

        <button onclick="window.location.href='index.html'">
            Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        </button>
    </div>

    <script>
        let db;
        const DB_NAME = "AttendanceSystemDB";
        const DB_VERSION = 4; // ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©

        function connectDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = e => {
                    resolve(e.target.result); 
                };

                request.onsuccess = e => {
                    resolve(e.target.result);
                };

                request.onerror = e => {
                    reject("ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø²ÙŠØ§Ø±Ø© Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹.");
                };
            });
        }

        async function loadDebtTracker() {
            const container = document.getElementById('debtListContainer');
            let totalDebt = 0;

            try {
                db = await connectDB();
            } catch (error) {
                container.innerHTML = `<p style="text-align:center; color:#f44336; font-size:18px; padding: 50px; background: #fff; border-radius: 10px;">âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error}</p>`;
                return;
            }

            const tx = db.transaction("teachers", "readonly");
            tx.objectStore("teachers").getAll().onsuccess = e => {
                const teachers = e.target.result;
                const debtStudents = [];

                // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø°ÙŠÙ† Ø¹Ù„ÙŠÙ‡Ù… Ø¯ÙŠÙˆÙ† ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº
                teachers.forEach(teacher => {
                    const pricePerClass = teacher.pricePerClass || 0;
                    const pricePer4Classes = teacher.pricePer4Classes || 0;

                    teacher.students.forEach(student => {
                        if (student.debtPaid === false && (student.debtClassesCount > 0 || student.attendance.some(s => s !== 'transparent'))) {
                            
                            // Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø§Ù„ØªÙŠ ØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡Ø§ ÙˆÙ„Ù… ÙŠØªÙ… ØªØ¬Ø¯ÙŠØ¯Ù‡Ø§ Ø¨Ø¹Ø¯
                            const currentClasses = student.attendance.filter(status => status !== "transparent").length;
                            
                            // Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù„Ø­ØµØµ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© (Ù…Ù† Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© + Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ)
                            const totalDebtClasses = (student.debtClassesCount || 0) + currentClasses;

                            let debtAmount = 0;

                            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚
                            if (totalDebtClasses >= 4 && pricePer4Classes > 0) {
                                // Ù†Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø¹Ù„Ù‰ Ø£Ø³Ø§Ø³ Ø³Ø¹Ø± Ø§Ù„Ø¨Ø§Ù‚Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø³Ø¹Ø± Ù„Ù„Ø¨Ø§Ù‚Ø© ÙˆØªÙ… ØªØ¬Ø§ÙˆØ² 4 Ø­ØµØµ
                                const fullPacks = Math.floor(totalDebtClasses / 4);
                                const remainder = totalDebtClasses % 4;
                                debtAmount = (fullPacks * pricePer4Classes) + (remainder * pricePerClass);
                            } else {
                                // Ù†Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø¹Ù„Ù‰ Ø£Ø³Ø§Ø³ Ø³Ø¹Ø± Ø§Ù„Ø­ØµØ©
                                debtAmount = totalDebtClasses * pricePerClass;
                            }
                            
                            totalDebt += debtAmount;

                            debtStudents.push({
                                studentName: student.name,
                                teacherName: teacher.name,
                                subject: teacher.subject,
                                debtClasses: totalDebtClasses,
                                debtAmount: debtAmount.toFixed(2)
                            });
                        }
                    });
                });

                // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                if (debtStudents.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color:#4caf50; font-size:18px; padding: 50px; background: #fff; border-radius: 10px;">ğŸ‰ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ø¹Ù„ÙŠÙ‡Ù… Ø¯ÙŠÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹. ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø¯ÙÙˆØ¹!</p>';
                } else {
                    let tableHTML = `
                        <p style="margin-bottom: 15px; font-weight: bold; font-size: 20px; color: white;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙŠÙˆÙ†: ${debtStudents.length}</p>
                        <p style="margin-bottom: 15px; font-weight: bold; font-size: 20px; color: #ffeb3b;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚: ${totalDebt.toFixed(2)}</p>
                        <table class="debt-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Ø§Ø³Ù… Ø§Ù„ØªÙ„Ù…ÙŠØ°</th>
                                    <th>Ø§Ù„Ø£Ø³ØªØ§Ø° (Ø§Ù„Ù…Ø§Ø¯Ø©)</th>
                                    <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ† Ø¨Ù‡Ø§</th>
                                    <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    debtStudents.forEach((d, index) => {
                        tableHTML += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${d.studentName}</td>
                                <td>${d.teacherName} (${d.subject})</td>
                                <td>${d.debtClasses}</td>
                                <td class="debt-amount">${d.debtAmount}</td>
                            </tr>
                        `;
                    });
                    tableHTML += `
                            </tbody>
                        </table>
                    `;
                    container.innerHTML = tableHTML;
                }
            };
        }
    </script>
</body>
</html>
