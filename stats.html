<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ±Ø§Øª</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        h1 { 
            text-align: center; 
            font-size: 32px; 
            margin-bottom: 30px; 
            color: #FFC107; 
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: rgba(255,255,255,0.95);
            color: #333;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .card h3 {
            font-size: 16px;
            color: #555;
            margin-bottom: 10px;
        }
        .card p {
            font-size: 28px;
            font-weight: bold;
            color: #1e3c72;
        }

        /* Tables and Details */
        h2 {
            font-size: 24px;
            color: #FFC107;
            border-bottom: 2px solid rgba(255, 193, 7, 0.5);
            padding-bottom: 10px;
            margin-top: 40px;
            margin-bottom: 20px;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            color: #333;
        }
        .data-table th, .data-table td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: right;
        }
        .data-table th {
            background: #2a5298;
            color: white;
            font-weight: 600;
        }
        .data-table tr:nth-child(even) {
            background-color: #f7f7f7;
        }
        .data-table tr:hover {
            background-color: #e0e0e0;
        }

        /* Action Buttons */
        .action-buttons {
            margin-top: 30px;
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        .action-buttons button {
            padding: 12px 25px;
            font-weight: bold;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: 0.3s;
            font-family: 'Cairo', sans-serif;
        }
        .btn-print { background: #4CAF50; color: white; }
        .btn-print:hover { background: #43A047; }
        .btn-back { background: #607D8B; color: white; }
        .btn-back:hover { background: #546E7A; }
        
        /* Loading/Error */
        #loading-message {
            text-align: center;
            font-size: 18px;
            color: #FFEB3B;
            margin-top: 50px;
        }

        /* Print Media Query */
        @media print {
            body { 
                background: #fff !important; 
                color: #000 !important; 
                padding: 0; 
                font-size: 11pt;
            }
            .container { 
                box-shadow: none !important; 
                border: none !important;
                background: #fff !important;
                max-width: none;
                margin: 0;
                padding: 10px;
            }
            .action-buttons, .btn-back {
                display: none !important;
            }
            h1, h2 {
                color: #000 !important;
                border-color: #333 !important;
            }
            .data-table th {
                background: #ccc !important;
                color: #000 !important;
            }
            .data-table { break-inside: avoid; }
            .summary-cards { break-inside: avoid; }
        }
    </style>
</head>
<body onload="loadAnalytics()">

    <div class="container">
        <h1>ğŸ“ˆ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ±Ø§Øª ÙˆØ§Ù„Ø¯Ø±Ø§Ø³Ø§Øª</h1>
        
        <div id="loading-message">ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>

        <div id="analytics-content" style="display: none;">
            
            <div class="summary-cards" id="summary-cards">
                </div>

            <h2>Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© (Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø¶ÙˆØ±)</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø£Ø³ØªØ§Ø°/Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</th>
                        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­ØµØµ Ø§Ù„Ù…Ù†Ø¬Ø²Ø© (Ø­Ø§Ø¶Ø±)</th>
                        <th>Ù…ØªÙˆØ³Ø· Ù†Ø³Ø¨Ø© Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ù„Ø§Ø¨ (%)</th>
                    </tr>
                </thead>
                <tbody id="teacher-performance-body">
                    </tbody>
            </table>
            
            <h2>Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨ ÙˆØ§Ù„Ø¯ÙØ¹Ø§Øª</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹</th>
                        <th>Ø§Ù„Ø£Ø³ØªØ§Ø°</th>
                        <th>Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©</th>
                        <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ø¯.Ø¬)</th>
                        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ (Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©)</th>
                    </tr>
                </thead>
                <tbody id="salaries-records-body">
                    </tbody>
            </table>

        </div>
        
        <div class="action-buttons">
            <button class="btn-print" onclick="printAnalytics()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
            <button class="btn-back" onclick="window.location.href='home.html'">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>

    </div>

    <script>
        let db;
        const DB_NAME = "AttendanceSystemDB";
        const DB_VERSION = 4; 

        // --- IndexedDB Connection ---

        function connectDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onsuccess = e => resolve(e.target.result);
                
                request.onerror = e => {
                    console.error("Error connecting to IndexedDB:", e.target.error);
                    reject(new DOMException("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª."));
                };
                
                // ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ù…ØªØ§Ø¬Ø± Ù‚Ø¯ Ø£Ù†Ø´Ø¦Øª Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù…Ù„ÙØ§Øª Ø£Ø®Ø±Ù‰
                request.onupgradeneeded = e => {
                    // Ù„Ø§ ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠ Ø´ÙŠØ¡ Ù‡Ù†Ø§ØŒ ÙÙ‚Ø· Ù„Ø¶Ù…Ø§Ù† ÙØªØ­ Ø§Ù„Ø§ØªØµØ§Ù„
                    console.log("Database upgrade triggered, but no stores created here.");
                };
            });
        }
        
        // --- Main Analytics Loader ---

        async function loadAnalytics() {
            try {
                db = await connectDB();
                
                document.getElementById("loading-message").style.display = 'none';
                
                // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø²Ù…Ø©
                const teachers = await getAllData("teachers");
                const salaries = await getAllData("salaries");
                
                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¨Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                const stats = processData(teachers, salaries);
                
                // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                renderSummaryCards(stats);
                renderTeacherPerformance(stats.teacherPerformance);
                renderSalariesRecords(salaries);
                
                document.getElementById("analytics-content").style.display = 'block';

            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:", error);
                document.getElementById("loading-message").innerHTML = 
                    `<p style="color: #F44336;">âš ï¸ Ø®Ø·Ø£: ${error.message || 'ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.'}</p>`;
            }
        }
        
        // --- Helper Function: Get All Data from Store ---
        
        function getAllData(storeName) {
            if (!db.objectStoreNames.contains(storeName)) {
                return Promise.resolve([]); // Ø§Ù„Ù…ØªØ¬Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù†Ø±Ø¬Ø¹ Ù…ØµÙÙˆÙØ© ÙØ§Ø±ØºØ©
            }
            
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, "readonly");
                const store = tx.objectStore(storeName);
                
                store.getAll().onsuccess = e => resolve(e.target.result);
                store.onerror = e => reject(e.target.error);
            });
        }

        // --- Core Data Processing ---

        function processData(teachers, salaries) {
            let totalStudents = 0;
            let totalClasses = 0; // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­ØµØµ Ø§Ù„Ø­Ø§Ø¶Ø±Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
            let totalSalaries = 0;
            const teacherPerformance = [];

            // 1. Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨
            salaries.forEach(s => {
                totalSalaries += parseFloat(s.teacherSalary);
            });

            // 2. ØªØ­Ù„ÙŠÙ„ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© ÙˆØ§Ù„Ø·Ù„Ø§Ø¨
            teachers.forEach(teacher => {
                let teacherTotalStudents = teacher.students.length;
                totalStudents += teacherTotalStudents;
                
                let totalPresentCount = 0; // Ù…Ø¬Ù…ÙˆØ¹ Ø­ØµØµ Ø§Ù„Ø­Ø¶ÙˆØ± Ù„ÙƒÙ„ Ø·Ù„Ø§Ø¨ Ø§Ù„Ø£Ø³ØªØ§Ø°
                let totalAttemptedSessions = 0; // Ù…Ø¬Ù…ÙˆØ¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­ØµØµ Ø§Ù„ØªÙŠ ÙƒØ§Ù† Ù…Ù† Ø§Ù„Ù…ÙØªØ±Ø¶ Ø­Ø¶ÙˆØ±Ù‡Ø§ (Ø­Ø§Ø¶Ø± + ØºØ§Ø¦Ø¨)
                
                teacher.students.forEach(student => {
                    const sessions = [];
                    
                    // Ø¬Ù…Ø¹ Ø§Ù„Ø­ØµØµ Ù…Ù† history Ùˆ attendance
                    const history = student.history || [];
                    const attendance = student.attendance || [];
                    const attendanceTimes = student.attendanceTimes || [];

                    history.forEach(batch => {
                        batch.status.forEach((status, index) => {
                            if (status !== 'transparent') sessions.push(status);
                        });
                    });
                    
                    attendance.forEach(status => {
                         if (status !== 'transparent') sessions.push(status);
                    });
                    
                    // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ (Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª)
                    sessions.forEach(status => {
                        if (status === 'present') {
                            totalPresentCount++;
                            totalClasses++; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù…
                        }
                        if (status === 'present' || status === 'absent') {
                            totalAttemptedSessions++;
                        }
                    });
                });
                
                // Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù„Ø£Ø³ØªØ§Ø°
                const averageAttendance = totalAttemptedSessions > 0 
                    ? (totalPresentCount / totalAttemptedSessions) * 100 
                    : 0;

                teacherPerformance.push({
                    name: teacher.name,
                    subject: teacher.subject,
                    studentCount: teacherTotalStudents,
                    totalPresentCount: totalPresentCount,
                    averageAttendance: averageAttendance.toFixed(2)
                });
            });
            
            // ÙØ±Ø² Ø§Ù„Ø£Ø¯Ø§Ø¡ (Ø§Ù„Ø£ÙØ¶Ù„ Ø£ÙˆÙ„Ø§Ù‹)
            teacherPerformance.sort((a, b) => b.averageAttendance - a.averageAttendance);


            return {
                totalTeachers: teachers.length,
                totalStudents: totalStudents,
                totalClasses: totalClasses,
                totalSalaries: totalSalaries.toFixed(2),
                teacherPerformance: teacherPerformance
            };
        }

        // --- Rendering Functions ---

        function renderSummaryCards(stats) {
            const container = document.getElementById("summary-cards");
            container.innerHTML = `
                <div class="card">
                    <h3>ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</h3>
                    <p>${stats.totalTeachers}</p>
                </div>
                <div class="card">
                    <h3>ğŸ“š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                    <p>${stats.totalStudents}</p>
                </div>
                <div class="card">
                    <h3>âœ”ï¸ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­ØµØµ Ø§Ù„Ù…Ù†Ø¬Ø²Ø© (Ø­Ø§Ø¶Ø±)</h3>
                    <p>${stats.totalClasses} Ø­ØµØ©</p>
                </div>
                <div class="card">
                    <h3>ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</h3>
                    <p>${stats.totalSalaries} Ø¯.Ø¬</p>
                </div>
            `;
        }

        function renderTeacherPerformance(performanceData) {
            const tbody = document.getElementById("teacher-performance-body");
            tbody.innerHTML = ''; 

            performanceData.forEach(p => {
                const row = tbody.insertRow();
                row.insertCell().textContent = `${p.name} (${p.subject})`;
                row.insertCell().textContent = p.studentCount;
                row.insertCell().textContent = p.totalPresentCount;
                row.insertCell().textContent = `${p.averageAttendance}%`;
                
                // ØªÙ„ÙˆÙŠÙ† Ø§Ù„ØµÙ Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø£ÙØ¶Ù„ ÙˆØ§Ù„Ø£Ù‚Ù„ Ø£Ø¯Ø§Ø¡
                const attendanceValue = parseFloat(p.averageAttendance);
                if (attendanceValue >= 90) {
                     row.style.backgroundColor = '#C8E6C9'; // Ø£Ø®Ø¶Ø± ÙØ§ØªØ­
                } else if (attendanceValue <= 60 && p.studentCount > 0) {
                     row.style.backgroundColor = '#FFCDD2'; // Ø£Ø­Ù…Ø± ÙØ§ØªØ­
                }
            });
        }
        
        function renderSalariesRecords(salaries) {
            const tbody = document.getElementById("salaries-records-body");
            tbody.innerHTML = ''; 
            
            // ÙØ±Ø² Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù…
            salaries.sort((a, b) => new Date(b.paymentDate) - new Date(a.paymentDate));

            salaries.forEach(s => {
                const row = tbody.insertRow();
                // ØªÙ†Ø³ÙŠÙ‚ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹
                const paymentDate = new Date(s.paymentDate).toLocaleDateString('ar-DZ'); 
                
                row.insertCell().textContent = paymentDate;
                row.insertCell().textContent = s.teacherName;
                row.insertCell().textContent = `${s.startDate} - ${s.endDate}`;
                row.insertCell().textContent = `${parseFloat(s.teacherSalary).toFixed(2)} Ø¯.Ø¬`;
                row.insertCell().textContent = `${s.totalAttendedCount}`;
            });
            
            if (salaries.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø±ÙˆØ§ØªØ¨ Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ø¹Ø¯.</td></tr>';
            }
        }

        // --- Action Function ---

        function printAnalytics() {
            if (document.getElementById("analytics-content").style.display === 'none') {
                alert("ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
                return;
            }
            // ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø®Ø§ØµÙŠØ© @media print ÙÙŠ CSS Ù„Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ…
            window.print();
        }

    </script>
</body>
</html>
