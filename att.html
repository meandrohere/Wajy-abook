<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø·ÙˆØ±Ù‘Ø©</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }
    h1 { text-align: center; font-size: 32px; margin-bottom: 20px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    
    .container { max-width: 700px; margin: 0 auto; }
    
    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« - ØªÙ… Ø¥Ø¶Ø§ÙØ© position: sticky Ùˆ top: 0 Ù„ØªØ«Ø¨ÙŠØªÙ‡ */
    .search-section {
      position: sticky; 
      top: 0; /* ØªØ«Ø¨ÙŠØª Ø§Ù„Ø­Ù‚Ù„ ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© */
      z-index: 100;
      background: rgba(30, 60, 114, 0.95); /* Ø®Ù„ÙÙŠØ© Ø«Ø§Ø¨ØªØ© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø´ÙØ§ÙÙŠØ© */
      padding: 15px; 
      border-radius: 15px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
      margin-bottom: 25px;
    }
    .search-input {
      background: #eee; color: #333; margin: 0 !important;
      border: 2px solid #ddd;
    }
    .search-input:focus { border-color: #2196f3; background: #fff; }

    .section {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }
    .price-inputs {
        display: flex; gap: 10px; margin: 10px 0;
    }
    .price-inputs input {
        flex: 1;
        text-align: right;
    }

    input, button {
      width: 100%; padding: 12px 15px; margin: 8px 0; border: none; border-radius: 10px;
      font-family: 'Cairo', sans-serif; font-size: 16px; outline: none;
    }
    input { background: rgba(255,255,255,0.9); color: #333; transition: 0.3s; }
    
    button {
      background: linear-gradient(90deg, #ff416c, #ff4b2b);
      color: white; font-weight: bold; cursor: pointer; transition: 0.3s;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    button:active { transform: scale(0.98); }
    
    .teacher {
      background: rgba(255,255,255,0.95);
      color: #333;
      border-radius: 15px;
      padding: 20px;
      margin: 15px 0;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .teacher-header {
      display: flex; justify-content: space-between; align-items: center;
      cursor: pointer; font-size: 20px; font-weight: 700; color: #2c3e50;
      border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 10px;
    }
    .teacher-details {
        font-size: 14px;
        color: #777;
        margin-top: 5px;
    }
    .arrow { font-size: 24px; transition: 0.3s; color: #777; }
    .arrow.open { transform: rotate(-90deg); color: #ff416c; }

    .students-list { display: none; }
    .students-list.open { display: block; } 

    .student {
      background: #f8f9fa; padding: 15px; border-radius: 12px; margin: 10px 0;
      border-right: 5px solid #4caf50;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    /* ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ù„ÙˆÙ† border-right Ù„Ù„Ø¯ÙŠÙ† Ù„ÙŠÙƒÙˆÙ† Ø£ÙƒØ«Ø± ÙˆØ¶ÙˆØ­Ø§Ù‹ */
    .student.archived { border-right-color: #ff9800; background: #fff8e1; } 
    
    .student-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 10px; 
    }
    .student-name { font-size: 18px; font-weight: bold; color: #333; }
    
    .debt-badge { 
        font-size: 12px; 
        padding: 4px 10px; 
        border-radius: 20px; 
        color: white; 
        font-weight: bold;
        min-width: 100px; /* Ù„Ø¶Ù…Ø§Ù† Ø¹Ø±Ø¶ ÙˆØ§Ø¶Ø­ */
        text-align: center;
    }
    .debt-badge.paid { background: #4caf50; }
    .debt-badge.unpaid { background: #f44336; }

    .attendance-boxes { display: flex; gap: 8px; justify-content: center; margin: 15px 0; }
    .box {
      width: 45px; height: 45px; border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-weight: bold; font-size: 18px; border: 2px solid #ddd;
      background: #fff; color: #ccc; cursor: help;
    }
    .box.present { background: #4caf50; color: white; border-color: #4caf50; }
    .box.absent { background: #f44336; color: white; border-color: #f44336; }

    .actions { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 10px; }
    .actions button { flex: 1; padding: 8px; font-size: 13px; min-width: 70px; margin: 0; }
    .btn-present { background: #4caf50 !important; }
    .btn-absent { background: #f44336 !important; }
    .btn-undo { background: #607d8b !important; }
    .btn-pay { background: #2196f3 !important; }
    .btn-remove { background: #333 !important; }

    /* Modal */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85); display: none;
      align-items: center; justify-content: center; z-index: 1000;
      backdrop-filter: blur(5px);
    }
    .modal-box {
      background: #fff; color: #333; padding: 30px;
      border-radius: 20px; text-align: center; width: 90%; max-width: 400px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }

    .toast {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
      padding: 12px 30px; background: #333; color: white;
      border-radius: 30px; font-weight: bold; z-index: 2000;
      opacity: 0; transition: 0.5s; pointer-events: none;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
  </style>
</head>
<body>

  <div id="main-page">
    <h1>Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ğŸ“š</h1>
    <div class="container">
      
      <div class="search-section">
        <input type="text" id="globalSearchInput" class="search-input" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† ØªÙ„Ù…ÙŠØ°..." onkeyup="searchStudents()">
      </div>

      <div class="section">
        <h3 style="margin-bottom: 10px;">Ø¥Ø¶Ø§ÙØ© Ø£Ø³ØªØ§Ø° Ø¬Ø¯ÙŠØ¯</h3>
        <input type="text" id="teacherName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø°">
        <input type="text" id="subjectName" placeholder="Ø§Ù„Ù…Ø§Ø¯Ø©">
        
        <div class="price-inputs">
            <input type="number" id="pricePerClass" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø­ØµØ© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©">
            <input type="number" id="pricePer4Classes" placeholder="Ø³Ø¹Ø± Ø¨Ø§Ù‚Ø© 4 Ø­ØµØµ">
        </div>
        
        <button onclick="addTeacher()">+ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³ØªØ§Ø°</button>
      </div>

      <div id="teachersContainer"></div>
    </div>
  </div>

  <div class="modal-overlay" id="renewModal">
    <div class="modal-box">
      <h3>âš ï¸ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù€ 4 Ø­ØµØµ</h3>
      <p style="margin-bottom: 20px;">Ù‡Ù„ Ù‚Ø§Ù… Ø§Ù„ØªÙ„Ù…ÙŠØ° Ø¨Ø¯ÙØ¹ Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ØŸ</p>
      <div style="display: flex; gap: 10px;">
        <button onclick="renewSubscription(true)" style="background: #4caf50;">Ù†Ø¹Ù…ØŒ Ø¯ÙØ¹</button>
        <button onclick="renewSubscription(false)" style="background: #f44336;">Ù„Ø§ØŒ Ù„Ù… ÙŠØ¯ÙØ¹</button>
      </div>
      <button onclick="closeModal()" style="background: #777; margin-top: 10px;">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>

  <div class="toast" id="toastMsg">ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­</div>

  <script>
    let db;
    let currentRenewStudent = null;

    // *** Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø± 4 ÙŠØ¯Ø¹Ù… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ØªØ¬Ø± ***
    const request = indexedDB.open("AttendanceSystemDB", 4); 

    request.onupgradeneeded = e => {
      db = e.target.result;
      if (!db.objectStoreNames.contains("teachers")) {
        db.createObjectStore("teachers", { keyPath: "id", autoIncrement: true });
        console.log("Teachers object store created/upgraded.");
      }
      // Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ù…Ù„Ù payroll.html Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ØŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªØ¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ø£ÙŠØ¶Ø§Ù‹ ØªÙ‡ÙŠØ¦Ø© Ù…ØªØ¬Ø± salaries
      if (!db.objectStoreNames.contains("salaries")) {
           db.createObjectStore("salaries", { keyPath: "id", autoIncrement: true });
           console.log("Salaries object store created/upgraded.");
      }
    };

    request.onsuccess = e => {
      db = e.target.result;
      console.log("IndexedDB opened successfully.");
      loadTeachers();
    };
    
    request.onerror = e => {
        console.error("Error opening IndexedDB:", e.target.error);
        alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± Ø®Ø§Ø¯Ù… ÙˆÙŠØ¨ (HTTP) Ø£Ùˆ Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©.");
    };

    // --- Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø«Ø§Ø¨ØªØ© ---
    function searchStudents() {
      const query = document.getElementById('globalSearchInput').value.toLowerCase().trim();
      const teachers = document.querySelectorAll('.teacher');

      teachers.forEach(teacherDiv => {
        const studentsList = teacherDiv.querySelector('.students-list');
        const arrow = teacherDiv.querySelector('.arrow');
        const students = teacherDiv.querySelectorAll('.student');
        let hasMatch = false;

        // Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø«
        students.forEach(student => {
          const name = student.querySelector('.student-name').textContent.toLowerCase();
          if (name.includes(query)) {
            student.style.display = "block";
            hasMatch = true;
          } else {
            student.style.display = "none";
          }
        });

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø³ØªØ§Ø° ÙˆÙ‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
        if (query === "") {
          teacherDiv.style.display = "block";
          studentsList.classList.remove('open');
          arrow.classList.remove('open');
          // Ø¹Ù†Ø¯ Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«ØŒ Ù†Ø¹ÙŠØ¯ Ø¥Ø¸Ù‡Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨
          students.forEach(student => student.style.display = "block"); 
        } else if (hasMatch) {
          teacherDiv.style.display = "block";
          studentsList.classList.add('open');
          arrow.classList.add('open');
        } else {
          teacherDiv.style.display = "none";
        }
      });
    }

    // --- Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---

    function addTeacher() {
      if (!db) return showToast("Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©");
      const name = document.getElementById("teacherName").value.trim();
      const subject = document.getElementById("subjectName").value.trim();
      // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ø¥Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙˆØªØ¹ÙŠÙŠÙ† 0 ÙƒÙ‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ© Ø£Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­Ø©
      const pricePerClass = parseFloat(document.getElementById("pricePerClass").value) || 0;
      const pricePer4Classes = parseFloat(document.getElementById("pricePer4Classes").value) || 0;
      
      if (!name || !subject) return showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø° ÙˆØ§Ù„Ù…Ø§Ø¯Ø©");
      if (pricePerClass <= 0 && pricePer4Classes <= 0) return showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø³Ø¹Ø± Ø§Ù„Ø­ØµØ© Ø£Ùˆ Ø§Ù„Ø¨Ø§Ù‚Ø©");

      const tx = db.transaction("teachers", "readwrite");
      tx.objectStore("teachers").add({ 
        name, 
        subject, 
        pricePerClass, 
        pricePer4Classes, 
        students: [] 
      });
      tx.oncomplete = () => {
        document.getElementById("teacherName").value = "";
        document.getElementById("subjectName").value = "";
        document.getElementById("pricePerClass").value = "";
        document.getElementById("pricePer4Classes").value = "";
        showToast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³ØªØ§Ø°");
        loadTeachers();
      };
    }

    function loadTeachers() {
      if (!db) return; // Ù…Ù†Ø¹ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©
      const container = document.getElementById("teachersContainer");
      container.innerHTML = "";
      
      const tx = db.transaction("teachers", "readonly");
      tx.objectStore("teachers").getAll().onsuccess = e => {
        const teachers = e.target.result;
        teachers.forEach((teacher) => {
          // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
          const pricePerClass = teacher.pricePerClass || 0;
          const pricePer4Classes = teacher.pricePer4Classes || 0;

          const div = document.createElement("div");
          div.className = "teacher";
          div.innerHTML = `
            <div class="teacher-header" onclick="toggleStudents(${teacher.id})">
              <span>ğŸ‘¨â€ğŸ« ${teacher.name} - ${teacher.subject}</span>
              <span class="arrow" id="arrow-${teacher.id}">â®</span>
            </div>
            <div class="teacher-details">
                Ø³Ø¹Ø± Ø§Ù„Ø­ØµØ©: **${pricePerClass}** | Ø³Ø¹Ø± Ø§Ù„Ø¨Ø§Ù‚Ø© (4 Ø­ØµØµ): **${pricePer4Classes}**
            </div>
            <div class="students-list" id="list-${teacher.id}">
              <div style="display:flex; gap:10px;">
                <input type="text" id="input-${teacher.id}" placeholder="Ø§Ø³Ù… Ø§Ù„ØªÙ„Ù…ÙŠØ° Ø§Ù„Ø¬Ø¯ÙŠØ¯" 
                       onkeypress="if(event.key==='Enter') addStudent(${teacher.id})">
                <button onclick="addStudent(${teacher.id})" style="width:auto; padding:0 20px;">+</button>
              </div>
              <div id="students-container-${teacher.id}"></div>
              <button onclick="deleteTeacher(${teacher.id})" style="background:#555; margin-top:15px; font-size:12px;">Ø­Ø°Ù Ø§Ù„Ø£Ø³ØªØ§Ø°</button>
            </div>
          `;
          container.appendChild(div);
          renderStudents(teacher.id, teacher.students);
        });
      };
    }

    function toggleStudents(id) {
      if(document.getElementById('globalSearchInput').value.trim() !== "") return;
      const list = document.getElementById(`list-${id}`);
      const arrow = document.getElementById(`arrow-${id}`);
      list.classList.toggle("open");
      arrow.classList.toggle("open");
    }

    function addStudent(teacherId) {
      const input = document.getElementById(`input-${teacherId}`);
      const name = input.value.trim();
      if (!name) return;

      processTeacher(teacherId, (teacher) => {
        teacher.students.push({
          name: name,
          attendance: ["transparent", "transparent", "transparent", "transparent"],
          attendanceTimes: [null, null, null, null],
          history: [],
          debtPaid: true, 
          debtClassesCount: 0 
        });
        input.value = "";
        showToast(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨: ${name}`);
        return true;
      });
    }

    function renderStudents(teacherId, students) {
      const container = document.getElementById(`students-container-${teacherId}`);
      container.innerHTML = "";

      students.forEach((s, sIdx) => {
        // *** ØªØ¹Ø¯ÙŠÙ„: ØªÙ‡ÙŠØ¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© Ù„Ø¶Ù…Ø§Ù† Ù‚ÙˆØ© Ø§Ù„ØªØ­Ù…Ù„ ***
        if (!s.attendanceTimes) s.attendanceTimes = [null, null, null, null];
        if (s.debtClassesCount === undefined) s.debtClassesCount = 0;
        if (s.debtPaid === undefined) s.debtPaid = true;
        if (!s.history) s.history = []; // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø±Ø´ÙØ©

        const isDebt = !s.debtPaid;
        const debtDisplay = s.debtClassesCount > 0 ? ` (${s.debtClassesCount} Ø­ØµØ©)` : '';
        const badgeText = s.debtPaid ? 'Ù…Ø¯ÙÙˆØ¹' : `Ø¹Ù„ÙŠÙ‡ Ø¯ÙŠÙ†${debtDisplay}`;


        const boxesHTML = s.attendance.map((status, i) => {
          // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø§Ù„ÙØ£Ø±Ø©
          const time = s.attendanceTimes[i] ? `\nØªØ§Ø±ÙŠØ®: ${new Date(s.attendanceTimes[i]).toLocaleDateString('ar-DZ')} ${new Date(s.attendanceTimes[i]).toLocaleTimeString('ar-DZ')}` : "";
          const titleText = status === "transparent" ? "Ù„Ù… ÙŠØ³Ø¬Ù„ Ø¨Ø¹Ø¯" : (status === "present" ? "Ø­Ø§Ø¶Ø±" : "ØºØ§Ø¦Ø¨") + time;
          
          return `<div class="box ${status}" title="${titleText}">${i + 1}</div>`;
        }).join("");

        const studentDiv = document.createElement("div");
        studentDiv.className = `student ${isDebt ? 'archived' : ''}`;
        studentDiv.innerHTML = `
          <div class="student-header">
            <span class="student-name">${s.name}</span>
            <span class="debt-badge ${s.debtPaid ? 'paid' : 'unpaid'}">
              ${badgeText}
            </span>
          </div>
          <div class="attendance-boxes">${boxesHTML}</div>
          
          <div class="actions">
            <button class="btn-present" onclick="markAttendance(${teacherId}, ${sIdx}, 'present')">Ø­Ø§Ø¶Ø±</button>
            <button class="btn-absent" onclick="markAttendance(${teacherId}, ${sIdx}, 'absent')">ØºØ§Ø¦Ø¨</button>
            <button class="btn-undo" onclick="undoAttendance(${teacherId}, ${sIdx})">ØªØ±Ø§Ø¬Ø¹</button>
            <button class="btn-pay" onclick="toggleDebt(${teacherId}, ${sIdx})">
              ${s.debtPaid ? 'ØªØºÙŠÙŠØ± Ø¥Ù„Ù‰ Ø¯ÙŠÙ†' : 'ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹'}
            </button>
            <button class="btn-remove" onclick="removeStudent(${teacherId}, ${sIdx})">Ø­Ø°Ù</button>
          </div>
        `;
        container.appendChild(studentDiv);
      });
    }

    // --- Ø§Ù„Ù…Ù†Ø·Ù‚ Ù…Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª ---

    function markAttendance(tId, sIdx, status) {
      processTeacher(tId, (teacher) => {
        const student = teacher.students[sIdx];
        // *** ØªØ¹Ø¯ÙŠÙ„: ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø£ÙŠØ¶Ø§Ù‹ ***
        if (!student.attendanceTimes) student.attendanceTimes = [null, null, null, null];
        if (student.debtClassesCount === undefined) student.debtClassesCount = 0;
        if (student.debtPaid === undefined) student.debtPaid = true;

        const emptyIndex = student.attendance.indexOf("transparent");
        if (emptyIndex === -1) {
          currentRenewStudent = { tId, sIdx };
          document.getElementById("renewModal").style.display = "flex";
          return false;
        }

        student.attendance[emptyIndex] = status;
        
        // ** ØªØ¹Ø¯ÙŠÙ„: Ø­ÙØ¸ Ø§Ù„ÙˆÙ‚Øª Ø¨ØµÙŠØºØ© ISO Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© ÙÙŠ Ù…Ù„Ù ÙƒØ´Ù Ø§Ù„Ø±ÙˆØ§ØªØ¨ **
        const now = new Date().toISOString(); 
        student.attendanceTimes[emptyIndex] = now;

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯ÙŠÙˆÙ† ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ Ù‡ÙŠ (Ø¹Ù„ÙŠÙ‡ Ø¯ÙŠÙ†) ÙˆØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±/ØºÙŠØ§Ø¨
        if (student.debtPaid === false) {
             student.debtClassesCount += 1;
        }

        showToast(status === 'present' ? "ØªÙ… Ø§Ù„Ø­Ø¶ÙˆØ±" : "ØªÙ… Ø§Ù„ØºÙŠØ§Ø¨");
        return true;
      });
    }

    function undoAttendance(tId, sIdx) {
      processTeacher(tId, (teacher) => {
        const student = teacher.students[sIdx];
        const att = student.attendance;
        // *** ØªØ¹Ø¯ÙŠÙ„: ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø£ÙŠØ¶Ø§Ù‹ ***
        if (!student.attendanceTimes) student.attendanceTimes = [null, null, null, null];
        if (student.debtClassesCount === undefined) student.debtClassesCount = 0;
        if (student.debtPaid === undefined) student.debtPaid = true;


        for (let i = att.length - 1; i >= 0; i--) {
          if (att[i] !== "transparent") {
            att[i] = "transparent";
            student.attendanceTimes[i] = null;
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯ÙŠÙˆÙ† Ø¨Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø§Ù„Ø­ØµØ© ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù† Ø¹Ù„ÙŠÙ‡ Ø¯ÙŠÙ†
            if (student.debtPaid === false && student.debtClassesCount > 0) {
                 student.debtClassesCount -= 1;
            }

            showToast("ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹");
            return true;
          }
        }
        return false;
      });
    }

    function toggleDebt(tId, sIdx) {
        processTeacher(tId, (teacher) => {
            const student = teacher.students[sIdx];
            // *** ØªØ¹Ø¯ÙŠÙ„: ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø£ÙŠØ¶Ø§Ù‹ ***
            if (student.debtClassesCount === undefined) student.debtClassesCount = 0;
            if (student.debtPaid === undefined) student.debtPaid = true;
            
            if (student.debtPaid === false) {
                // ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹: ÙŠØµÙÙ‘Ø± Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯ÙŠÙˆÙ† ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ ØªØµØ¨Ø­ Ù…Ø¯ÙÙˆØ¹
                student.debtPaid = true;
                student.debtClassesCount = 0;
                showToast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ ÙˆØªØµÙÙŠØ± Ø§Ù„Ø­ØµØµ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©");
            } else {
                // ØªØºÙŠÙŠØ± Ø¥Ù„Ù‰ Ø¯ÙŠÙ†: Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ ØªØµØ¨Ø­ Ø¹Ù„ÙŠÙ‡ Ø¯ÙŠÙ† (Ù†Ø­ØªÙØ¸ Ø¨Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ Ø§Ù„Ø­Ø§Ù„ÙŠØ©)
                student.debtPaid = false;
                // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ø¯ÙŠÙ†ØŒ ÙŠØ¬Ø¨ Ø£Ù† Ù†Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø¨Ø§Ù‚Ø© ÙƒØ¯ÙŠÙ† Ù…Ø¨Ø¯Ø¦ÙŠ
                student.debtClassesCount = student.attendance.filter(status => status !== "transparent").length;
                showToast("ØªÙ… ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ Ø¥Ù„Ù‰ (Ø¹Ù„ÙŠÙ‡ Ø¯ÙŠÙ†)");
            }
            
            return true;
        });
    }

    function removeStudent(tId, sIdx) {
      if (!confirm("Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) return;
      processTeacher(tId, (teacher) => {
        teacher.students.splice(sIdx, 1);
        showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù");
        return true;
      });
    }

    function deleteTeacher(tId) {
      if (!confirm("Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø£Ø³ØªØ§Ø° ÙˆØ·Ù„Ø§Ø¨Ù‡!")) return;
      const tx = db.transaction("teachers", "readwrite");
      tx.objectStore("teachers").delete(tId);
      tx.oncomplete = () => { showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù"); loadTeachers(); };
    }

    // --- Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ù…Ø¹ Ø­ÙØ¸ Ø§Ù„Ø£Ø±Ø´ÙŠÙ ---
    function renewSubscription(isPaid) {
      if (!currentRenewStudent) return;
      const { tId, sIdx } = currentRenewStudent;

      processTeacher(tId, (teacher) => {
        const student = teacher.students[sIdx];
        // *** ØªØ¹Ø¯ÙŠÙ„: ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø£ÙŠØ¶Ø§Ù‹ ***
        if (!student.attendanceTimes) student.attendanceTimes = [null, null, null, null];
        if (student.debtClassesCount === undefined) student.debtClassesCount = 0;
        if (!student.history) student.history = [];
        
        // Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø­ØµØµ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©
        student.history.push({
          status: [...student.attendance],
          times: [...student.attendanceTimes]
        });

        const attendedClasses = student.attendance.filter(status => status !== "transparent").length;
        
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¯ÙØ¹ (isPaid=false)ØŒ Ù†Ø¶ÙŠÙ Ø­ØµØµ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ Ø¥Ù„Ù‰ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ
        if (isPaid === false) {
            student.debtClassesCount += attendedClasses;
        } else {
             // Ø¥Ø°Ø§ Ø¯ÙØ¹ (isPaid=true)ØŒ Ù†ÙØµÙÙ‘Ø± Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯ÙŠÙˆÙ†
             student.debtClassesCount = 0;
        }

        // ØªØµÙÙŠØ± Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
        student.attendance = ["transparent", "transparent", "transparent", "transparent"];
        student.attendanceTimes = [null, null, null, null];
        student.debtPaid = isPaid; 

        showToast("ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯");
        closeModal();
        return true;
      });
    }

    function closeModal() {
      document.getElementById("renewModal").style.display = "none";
      currentRenewStudent = null;
    }

    function processTeacher(id, callback) {
      if (!db) return showToast("Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¹Ù…Ù„ÙŠØ©");
      const tx = db.transaction("teachers", "readwrite");
      const store = tx.objectStore("teachers");
      store.get(id).onsuccess = e => {
        const teacher = e.target.result;
        if (teacher && callback(teacher)) {
          store.put(teacher);
          renderStudents(id, teacher.students);
        } else if (!teacher) {
             console.error("Teacher not found with ID:", id);
        }
      };
      tx.onerror = e => {
        console.error("Transaction failed during processTeacher:", e.target.error);
        showToast("ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
      };
    }

    function showToast(msg) {
      const toast = document.getElementById("toastMsg");
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }
  </script>
</body>
</html>
