<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 50px auto;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            text-align: center;
        }
        h1 { 
            font-size: 30px; 
            margin-bottom: 25px; 
            color: #FFC107; 
        }
        .section {
            background: rgba(255,255,255,0.95);
            color: #333;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .section h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #1e3c72;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        button {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }
        /* Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ */
        #backupButton {
            background: #4CAF50; /* Ø£Ø®Ø¶Ø± */
            color: white;
        }
        #backupButton:hover { background: #43A047; }

        /* Ø²Ø± Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© */
        #restoreButton {
            background: #FF9800; /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
            color: white;
            margin-top: 15px;
        }
        #restoreButton:hover { background: #FB8C00; }

        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px dashed #ccc;
            border-radius: 8px;
            margin-bottom: 15px;
            background: #f8f8f8;
            color: #333;
        }
        
        .note {
            font-size: 14px;
            color: #777;
            margin-top: 10px;
            line-height: 1.5;
        }
        .danger-note {
            color: #F44336;
            font-weight: bold;
        }
        .back-button {
            background: #607D8B;
            color: white;
            margin-top: 30px;
        }
        .back-button:hover { background: #546E7A; }
    </style>
</head>
<body onload="connectDB()">

    <div class="container">
        <h1>âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h1>

        <div class="section">
            <h2>Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ (ØªØµØ¯ÙŠØ±)</h2>
            <p class="note">Ø³ÙŠØªÙ… Ø­ÙØ¸ Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© ÙˆØ§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ.</p>
            <button id="backupButton" onclick="exportData()">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
        </div>

        <div class="section">
            <h2>Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ø³ØªÙŠØ±Ø§Ø¯)</h2>
            <p class="danger-note">ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø³ØªØ­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØªØ³ØªØ¨Ø¯Ù„Ù‡Ø§ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø°ÙŠ ØªØ®ØªØ§Ø±Ù‡.</p>
            
            <input type="file" id="restoreFile" accept=".json" onchange="enableRestoreButton()">
            
            <button id="restoreButton" onclick="importData()" disabled>â¬†ï¸ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¢Ù†</button>
            <p class="note">Ø§Ø®ØªØ± Ù…Ù„Ù **JSON** ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù†Ø¸Ø§Ù….</p>
        </div>
        
        <button class="back-button" onclick="window.location.href='home.html'">
            Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        </button>

    </div>

    <script>
        let db;
        const DB_NAME = "AttendanceSystemDB";
        const DB_VERSION = 4;
        const STORE_NAMES = ["teachers", "salaries"];

        // --- IndexedDB Connection ---

        function connectDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            
            request.onupgradeneeded = e => {
                const db = e.target.result;
                STORE_NAMES.forEach(storeName => {
                    if (!db.objectStoreNames.contains(storeName)) {
                        db.createObjectStore(storeName, { keyPath: "id", autoIncrement: true });
                    }
                });
            };

            request.onsuccess = e => {
                db = e.target.result;
                console.log("IndexedDB connected.");
            };
            
            request.onerror = e => {
                console.error("Error opening IndexedDB:", e.target.error);
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
            };
        }

        // --- Export/Backup Function ---

        async function exportData() {
            if (!db) {
                alert("Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØµÙ„Ø© Ø¨Ø¹Ø¯. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
                return;
            }

            const data = {};
            try {
                // Ù†Ø³ØªØ®Ø¯Ù… Promise.all Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØ§Ø¬Ø± Ø¨Ø§Ù„ØªÙˆØ§Ø²ÙŠ
                const promises = STORE_NAMES.map(storeName => {
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction(storeName, "readonly");
                        const store = tx.objectStore(storeName);
                        store.getAll().onsuccess = e => {
                            data[storeName] = e.target.result;
                            resolve();
                        };
                        tx.onerror = reject;
                    });
                });

                await Promise.all(promises);

                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙ†Ø²ÙŠÙ„
                const a = document.createElement('a');
                a.href = url;
                const date = new Date().toISOString().substring(0, 10);
                a.download = `backup_AttendanceSystemDB_${date}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!");

            } catch (error) {
                console.error("ÙØ´Ù„ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
                alert("ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©. Ø±Ø§Ø¬Ø¹ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡.");
            }
        }

        // --- Import/Restore Functions ---
        
        function enableRestoreButton() {
            const fileInput = document.getElementById('restoreFile');
            document.getElementById('restoreButton').disabled = !fileInput.files.length;
        }

        function importData() {
            if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§!")) {
                return;
            }
            
            if (!db) {
                alert("Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØµÙ„Ø© Ø¨Ø¹Ø¯. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
                return;
            }
            
            const file = document.getElementById('restoreFile').files[0];
            if (!file) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù JSON Ù„Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©.");
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    await clearAndPopulateDB(importedData);
                    alert("ğŸ‰ ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù….");
                    window.location.reload(); 
                } catch (error) {
                    console.error("Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©:", error);
                    alert("ÙØ´Ù„ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù Ø¨ØµÙŠØºØ© JSON ØµØ­ÙŠØ­Ø©.");
                }
            };
            reader.readAsText(file);
        }

        async function clearAndPopulateDB(data) {
            // ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            const tx = db.transaction(STORE_NAMES, "readwrite");
            
            for (const storeName of STORE_NAMES) {
                if (data[storeName]) {
                    const store = tx.objectStore(storeName);
                    
                    // 1. Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
                    await new Promise(resolve => {
                        store.clear().onsuccess = resolve;
                    });
                    
                    // 2. Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                    data[storeName].forEach(item => {
                        // ÙŠØ¬Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¯Ø®Ø§Ù„Ù‡Ø§ ÙƒÙ€ add() ÙˆÙ„ÙŠØ³ put() Ù„ØªØ¬Ù†Ø¨ ØªØ¶Ø§Ø±Ø¨ Ø§Ù„Ù€ primary keys Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                        // Ù„ÙƒÙ†Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… put Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù€ ID Ù†ÙØ³Ù‡ (Ù„ØªØ¬Ù†Ø¨ ÙƒØ³Ø± Ø§Ù„Ø±ÙˆØ§Ø¨Ø·)
                        store.put(item).onerror = (e) => {
                             console.warn(`ÙØ´Ù„ ÙÙŠ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ ${storeName}:`, item, e.target.error);
                        };
                    });
                }
            }
            
            return new Promise((resolve, reject) => {
                tx.oncomplete = resolve;
                tx.onerror = reject;
            });
        }

    </script>
</body>
</html>
