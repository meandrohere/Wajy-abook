<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تسجيل - مدير الأقسام</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; margin:0; padding:0; }
  body {
    font-family: 'Cairo', sans-serif;
    background: linear-gradient(135deg, #1e3c72, #2a5298);
    color: #fff;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .container {
    max-width: 420px;
    width: 90%;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(12px);
    padding: 35px 25px;
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    animation: fadeIn 0.8s ease;
    text-align: center;
  }
  h2 {
    margin-bottom: 25px;
    font-size: 24px;
    font-weight: bold;
  }
  input {
    width: 100%;
    padding: 14px;
    margin: 12px 0;
    border: none;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.25);
    color: #fff;
    font-size: 16px;
  }
  input::placeholder {
    color: #ddd;
  }
  button {
    width: 100%;
    padding: 14px;
    margin: 15px 0 8px;
    border: none;
    border-radius: 12px;
    background: linear-gradient(90deg, #ff416c, #ff4b2b);
    color: white;
    font-weight: bold;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s;
  }
  button:hover {
    background: linear-gradient(90deg, #ff4b2b, #ff416c);
    transform: translateY(-2px);
  }
  button:last-child {
    background: rgba(255,255,255,0.2);
  }
  button:last-child:hover {
    background: rgba(255,255,255,0.3);
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-30px); }
    to { opacity: 1; transform: translateY(0); }
  }
  /* تم إزالة #auth-section من الإخفاء. فقط #register-section يبقى مخفياً */
  #register-section { display: none; }
</style>
</head>
<body>

<div class="container" id="auth-section">
  <h2>مرحباً بك في نظام إدارة الأقسام</h2>
  <p>إذا كنت تمتلك حسابًا بالفعل، فسيتم توجيهك تلقائيًا...</p>
  <button onclick="showRegister()">إنشاء حساب جديد</button>
</div>

<div class="container" id="register-section">
  <h2>إنشاء حساب مدير</h2>
  <input type="text" id="school-name" placeholder="اسم المدرسة" required>
  <input type="text" id="manager-name" placeholder="اسم المدير الحقيقي (3 أحرف على الأقل)" required>
  <input type="password" id="register-password" placeholder="كلمة المرور" required>
  <button onclick="register()">تسجيل الآن</button>
  <button onclick="backToAuth()">رجوع</button>
</div>

<script>
let db;

// *** فتح قاعدة البيانات بالإصدار 3 لضمان التحديث والتهيئة الصحيحة ***
const request = indexedDB.open("sectionsManagerDB", 3);

request.onupgradeneeded = function(event) {
  db = event.target.result;

  if (db.objectStoreNames.contains("users")) {
    db.deleteObjectStore("users");
  }

  db.createObjectStore("users", { autoIncrement: true });
};

request.onsuccess = function(event) {
  db = event.target.result;
  checkExistingUser(); 
};

request.onerror = function(event) {
  console.error("خطأ في الوصول إلى قاعدة البيانات:", event.target.error);
  alert("خطأ في الوصول إلى قاعدة البيانات. يرجى إعادة المحاولة.");
  // لا حاجة لـ document.getElementById("auth-section").style.display = "block"; هنا، لأنه مرئي افتراضياً
};

// التحقق مما إذا كان هناك حساب مسبق
function checkExistingUser() {
  if (!db) {
    return; // الواجهة مرئية بالفعل، نوقف الدالة
  }

  try {
    const tx = db.transaction("users", "readonly");
    const store = tx.objectStore("users");
    const countReq = store.count();

    countReq.onsuccess = function() {
      if (countReq.result > 0) {
        // إذا كان هناك حساب → يتم التوجيه مباشرة
        window.location.href = "home.html";
      } else {
        // إذا لم يكن هناك حساب، تظل شاشة الترحيب مرئية (وهذا هو وضعها الافتراضي الآن)
      }
    };
    
    countReq.onerror = function(event) {
      console.error("خطأ في عملية عد المستخدمين:", event.target.error);
    };

    tx.onerror = function(event) {
      console.error("فشل في بدء المعاملة:", event.target.error);
    }

  } catch (e) {
    console.error("خطأ استثناء في IndexedDB (ربما NotFoundError):", e);
  }
}

function showRegister() {
  document.getElementById("auth-section").style.display = "none";
  document.getElementById("register-section").style.display = "block";
}

function backToAuth() {
  document.getElementById("register-section").style.display = "none";
  document.getElementById("auth-section").style.display = "block";
}

function register() {
  if (!db) {
    alert("قاعدة البيانات غير جاهزة. يرجى المحاولة مرة أخرى.");
    return;
  }
  
  const school = document.getElementById("school-name").value.trim();
  const manager = document.getElementById("manager-name").value.trim();
  const pass = document.getElementById("register-password").value;

  if (!school || !manager || !pass) {
    alert("يرجى تعبئة جميع الحقول!");
    return;
  }

  if (manager.length < 3) {
    alert("اسم المدير يجب أن يكون 3 أحرف على الأقل.");
    return;
  }

  const userData = { school, manager, pass };

  try {
    const tx = db.transaction("users", "readwrite");
    const store = tx.objectStore("users");
    const addReq = store.add(userData);

    addReq.onsuccess = function() {
      alert("تم إنشاء الحساب بنجاح! جاري التوجيه...");
      window.location.href = "home.html";
    };

    addReq.onerror = function(event) {
      console.error("خطأ أثناء حفظ البيانات:", event.target.error);
      alert("حدث خطأ أثناء حفظ البيانات. ربما تم إنشاء حساب من قبل.");
    };
    
    tx.onerror = function(event) {
      console.error("فشل في معاملة التسجيل:", event.target.error);
      alert("فشل في عملية تسجيل الحساب.");
    };

  } catch (e) {
    console.error("خطأ استثناء في IndexedDB أثناء التسجيل:", e);
    alert("فشل في بدء عملية التسجيل.");
  }
}
</script>

</body>
</html>
